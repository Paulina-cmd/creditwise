import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import MenuMas from "../components/MenuMas";
import "../assets/css/estilos.css";

export default function Missions() {
  const navigate = useNavigate();
  const [misiones, setMisiones] = useState([
    {
      id: 1,
      title: "ðŸ§© Entiende quÃ© es el crÃ©dito",
      desc: "Aprende quÃ© es, sus tipos y cÃ³mo diferenciar una deuda buena de una mala.",
      dificultad: "Media",
      progress: 0,
      estado: "En progreso",
      clase: "pendiente",
      bloqueada: false,
    },
    {
      id: 2,
      title: "ðŸ’³ Aprende cÃ³mo se calcula tu puntaje crediticio",
      desc: "Descubre los factores que afectan tu historial y cÃ³mo mejorarlo.",
      dificultad: "Alta",
      progress: 0,
      estado: "Bloqueada",
      clase: "bloqueada",
      bloqueada: true,
    },
  ]);

  const [selectedMision, setSelectedMision] = useState(null);

  // ðŸ”µ Revisar misiones completadas al cargar
  useEffect(() => {
    const completadas = JSON.parse(localStorage.getItem("misionesCompletadas")) || [];

    setMisiones((prev) =>
      prev.map((m, index) => {
        if (completadas.includes(m.id)) {
          return { ...m, progress: 100, estado: "Completada", clase: "completada", bloqueada: false };
        }
        // Desbloquear la siguiente misiÃ³n si la anterior estÃ¡ completada
        if (index > 0 && completadas.includes(prev[index - 1].id)) {
          return { ...m, bloqueada: false, estado: "En progreso", clase: "pendiente" };
        }
        return m;
      })
    );
  }, []);

  // ðŸ”µ FunciÃ³n para marcar misiÃ³n como completada desde MissionTask
  const completarMision = (id) => {
    const updated = misiones.map((m, index) => {
      if (m.id === id) {
        return { ...m, progress: 100, estado: "Completada", clase: "completada", bloqueada: false };
      }
      // Desbloquear siguiente misiÃ³n
      if (index > 0 && misiones[index - 1].id === id) {
        return { ...m, bloqueada: false, estado: "En progreso", clase: "pendiente" };
      }
      return m;
    });
    setMisiones(updated);

    // Guardar progreso en localStorage
    const completadas = JSON.parse(localStorage.getItem("misionesCompletadas")) || [];
    if (!completadas.includes(id)) completadas.push(id);
    localStorage.setItem("misionesCompletadas", JSON.stringify(completadas));
  };

  return (
    <div className="missions-page">
      {/* Sidebar */}
      <aside className="sidebar">
        <h2 className="logo">CreditWise</h2>
        <nav>
          <a href="/home">
            <img src="/img/hogar.png" alt="Inicio" className="icon" /> Inicio
          </a>
          <a href="/missions" className="active">
            <img src="/img/medalla-de-oro.png" alt="Misiones" className="icon" /> Misiones
          </a>
          <a href="/dollar">
            <img src="/img/inversion.png" alt="DÃ³lar" className="icon" /> DÃ³lar
          </a>
          <a href="/recommendation">
            <img src="/img/recomendacion.png" alt="Recomendaciones" className="icon" /> Recomendaciones
          </a>
          <a href="/history">
            <img src="/img/historial-de-transacciones.png" alt="Historial" className="icon" /> Historial
          </a>
          <a href="/profile">
            <img src="/img/usuario.png" alt="Perfil" className="icon" /> Perfil
          </a>
          <MenuMas />
        </nav>
      </aside>

      {/* Contenido principal */}
      <main className="main-content">
        <header className="header">
          <h1>Misiones</h1>
        </header>

        <section className="misiones">
          {misiones.map((mision) => (
            <div
              key={mision.id}
              className={`card mision ${mision.clase}`}
              onClick={() => !mision.bloqueada && setSelectedMision(mision)}
            >
              <h3>{mision.title}</h3>
              <p>{mision.desc}</p>

              {/* Barra de progreso */}
              <div className="progress-section">
                <div className="progress-container">
                  <div
                    className={`progress-bar ${mision.bloqueada ? "progress-bar-blocked" : ""}`}
                    style={{ width: `${mision.progress}%` }}
                  ></div>
                </div>
                <span className="progress-text">{mision.progress}%</span>
              </div>

              {/* Estado */}
              <span className={`estado ${mision.bloqueada ? "bloqueada" : "activa"}`}>
                {mision.bloqueada ? "ðŸ”’ Bloqueada" : mision.estado}
              </span>
            </div>
          ))}
        </section>
      </main>

      {/* Modal */}
      {selectedMision && (
        <div className="modal-overlay" onClick={() => setSelectedMision(null)}>
          <div className="modal-content" onClick={(e) => e.stopPropagation()}>
            <button className="modal-close" onClick={() => setSelectedMision(null)}>
              âœ–
            </button>
            <h2>{selectedMision.title}</h2>
            <p>{selectedMision.desc}</p>
            <p>
              <strong>Dificultad:</strong> {selectedMision.dificultad}
            </p>
            <button
              className="btn-ingresar"
              onClick={() =>
                navigate("/mission-task", {
                  state: { mision: selectedMision, completarMision },
                })
              }
            >
              Realizar misiÃ³n
            </button>
          </div>
        </div>
      )}

      <footer className="footer">
        <p>Â© {new Date().getFullYear()} CreditWise. Todos los derechos reservados.</p>
      </footer>
    </div>
  );
}

